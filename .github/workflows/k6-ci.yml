name: k6 load + browser

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'BASE_URL de Holisteek'
        required: true
        default: 'https://www.holisteek.com'
      city_query:
        description: 'Ciudad a buscar'
        required: true
        default: 'London'
      run_browser:
        description: 'Ejecutar suite de navegador (true/false)'
        required: true
        default: 'true'
  # Programa autom√°tico para ejecutar tests peri√≥dicamente
  schedule:
    - cron: "0 8 * * *"   # Ma√±ana 1: 8:00 AM UTC
    - cron: "0 10 * * *"  # Ma√±ana 2: 10:00 AM UTC
    - cron: "0 12 * * *"  # Mediod√≠a 1: 12:00 PM UTC
    - cron: "0 14 * * *"  # Mediod√≠a 2: 2:00 PM UTC
    - cron: "0 17 * * *"  # Tarde 1: 5:00 PM UTC
    - cron: "0 19 * * *"  # Tarde 2: 7:00 PM UTC
  # Ejecutar en cada push/PR
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # k6-http:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Run k6 (HTTP)
  #       uses: docker://grafana/k6:latest
  #       with:
  #         args: >-
  #           run --summary-trend-stats=avg,p(90),p(95),max
  #           scripts/http/home_search_city.http.js
  #       env:
  #         BASE_URL: ${{ github.event.inputs.base_url }}
  #         CITY_QUERY: ${{ github.event.inputs.city_query }}
  #         VU: '20'
  #         DURATION: '1m'

  #     - name: Save k6 summary artifacts
  #       if: always()
  #       run: |
  #         if [ -f report.html ]; then echo "report found"; else echo "no report.html yet"; fi
  #         ls -la || true

  #     - uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: k6-http-report
  #         path: |
  #           report.html
  #           summary.txt
  #         if-no-files-found: ignore

  k6-browser:
    if: ${{ github.event.inputs.run_browser == 'true' || github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: üöÄ Run k6 Browser Test
        continue-on-error: true
        id: k6-test
        run: |
          # Dar permisos de escritura para que k6 (ejecut√°ndose como root en container) pueda crear archivos
          chmod 777 .
          
          docker run --rm \
            -e K6_BROWSER_HEADLESS=true \
            -e K6_BROWSER_ARGS='--no-sandbox --disable-dev-shm-usage' \
            -v "$PWD:/work" -w /work \
            --cap-add=SYS_ADMIN \
            --security-opt seccomp=unconfined \
            grafana/k6:master-with-browser \
            run scripts/browser/holisteek_flow.browser.js
          
          echo "‚úÖ Test k6 completado"
          ls -la report.html summary.json
      
      - name: üîç Verificar generaci√≥n de reporte
        if: always()
        run: |
          echo "üìÇ Verificando archivos generados..."
          ls -lah
          echo ""
          echo "üîç Buscando report.html..."
          find . -name "report.html" -type f || echo "No se encontr√≥ report.html en ning√∫n lugar"
          echo ""
          if [ -f report.html ]; then
            echo "‚úÖ report.html encontrado en directorio ra√≠z"
            ls -lh report.html
          else
            echo "‚ö†Ô∏è report.html NO encontrado en directorio ra√≠z"
            echo "Intentando buscar en subdirectorios..."
            find . -name "*.html" -type f
          fi
      
      - name: ‚ö†Ô∏è Verificar si fallaron thresholds
        if: steps.k6-test.outcome == 'failure'
        run: |
          echo "::warning::‚ö†Ô∏è Los thresholds de k6 fueron superados, pero el test continu√≥ ejecut√°ndose."
          echo "::warning::Revisa el reporte HTML en GitHub Pages para ver los resultados detallados."

      - name: üìÅ Preparar reporte para GitHub Pages
        if: always()
        run: |
          if [ ! -f report.html ]; then
            echo "‚ùå ERROR: report.html no fue generado por k6"
            echo "Verificando logs del contenedor..."
            exit 1
          fi
          
          mkdir -p gh-pages-deploy/reports/${{ github.run_number }}
          cp report.html gh-pages-deploy/reports/${{ github.run_number }}/
          
          # Crear p√°gina principal con lista de reportes
          cat > gh-pages-deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>k6 Test Reports - Holisteek</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
              h1 { color: #333; }
              .report-card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .report-card a { color: #7d64ff; text-decoration: none; font-weight: bold; }
              .report-card a:hover { text-decoration: underline; }
              .meta { color: #666; font-size: 14px; margin-top: 5px; }
            </style>
          </head>
          <body>
            <h1>üìä k6 Performance Test Reports - Holisteek</h1>
            <p>Reportes de pruebas de rendimiento del flujo de b√∫squeda en Holisteek</p>
            <div class="report-card">
              <a href="reports/${{ github.run_number }}/report.html">üìÑ Reporte #${{ github.run_number }}</a>
              <div class="meta">
                Ejecutado: ${{ github.event.repository.updated_at }}<br>
                Commit: ${{ github.sha }}<br>
                Branch: ${{ github.ref_name }}
              </div>
            </div>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Reporte copiado a gh-pages-deploy/reports/${{ github.run_number }}/report.html"
          ls -la gh-pages-deploy/reports/${{ github.run_number }}/

      - name: üìä Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          keep_files: true

      - name: üìù Generate Report URL
        if: always()
        run: |
          REPORT_URL="https://anbepa.github.io/k6-holisteek-starter-2/reports/${{ github.run_number }}/report.html"
          echo "REPORT_URL=$REPORT_URL" >> $GITHUB_ENV
          echo "### üìä Reporte de Pruebas k6" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **URL del Reporte:** [$REPORT_URL]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Run Number: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
      - name: üéØ Upload Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-html-report-${{ github.run_number }}
          path: |
            report.html
            summary.json
          retention-days: 30

      - name: üìã Subir Summary JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-browser-summary
          path: summary.json
          retention-days: 30

      - name: üìà Comentar resultados en PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = '## üìä Resultados K6 Browser Test\n\n';
            
            try {
              const data = JSON.parse(fs.readFileSync('summary.json', 'utf8'));
              const m = data.metrics;
              
              // Checks
              const checksRate = (m.checks?.values?.rate * 100 || 0).toFixed(2);
              const checksTotal = (m.checks?.values?.passes || 0) + (m.checks?.values?.fails || 0);
              
              // Errores
              const errorRate = (m.tasa_errores?.values?.rate * 100 || 0).toFixed(2);
              
              summary += `### ‚úÖ Validaciones\n`;
              summary += `- **Checks:** ${m.checks?.values?.passes || 0}/${checksTotal} (${checksRate}%)\n`;
              summary += `- **Tasa de Errores:** ${errorRate}%\n\n`;
              
              summary += `### ‚è±Ô∏è Tiempos de Respuesta\n`;
              summary += `- **Carga P√°gina Home:** ${(m.carga_pagina_home_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Selecci√≥n Ciudad:** ${(m.tiempo_seleccion_ciudad_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Carga Resultados:** ${(m.tiempo_carga_resultados_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Flujo Completo:** ${(m.tiempo_total_flujo_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n\n`;
              
              summary += `### üåê Core Web Vitals\n`;
              summary += `- **LCP:** ${(m.browser_web_vital_lcp?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **FCP:** ${(m.browser_web_vital_fcp?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **CLS:** ${(m.browser_web_vital_cls?.values?.avg || 0).toFixed(6)}\n`;
              summary += `- **FID:** ${(m.browser_web_vital_fid?.values?.avg || 0).toFixed(2)}ms\n\n`;
              
              const reportUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/reports/${context.runNumber}/report.html`;
              summary += `üìä **[Ver Reporte Completo HTML ‚Üí](${reportUrl})**\n`;
              
            } catch (error) {
              summary += `‚ö†Ô∏è Error al leer summary.json: ${error.message}\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
