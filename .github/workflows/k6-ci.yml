name: k6 load + browser

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'BASE_URL de Holisteek'
        required: true
        default: 'https://www.holisteek.com'
      city_query:
        description: 'Ciudad a buscar'
        required: true
        default: 'London'
      run_browser:
        description: 'Ejecutar suite de navegador (true/false)'
        required: true
        default: 'true'
  # Programa autom√°tico para ejecutar tests peri√≥dicamente
  schedule:
    - cron: "0 9 * * *"  # Diario a las 9 AM UTC
  # Ejecutar en cada push/PR
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # k6-http:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Run k6 (HTTP)
  #       uses: docker://grafana/k6:latest
  #       with:
  #         args: >-
  #           run --summary-trend-stats=avg,p(90),p(95),max
  #           scripts/http/home_search_city.http.js
  #       env:
  #         BASE_URL: ${{ github.event.inputs.base_url }}
  #         CITY_QUERY: ${{ github.event.inputs.city_query }}
  #         VU: '20'
  #         DURATION: '1m'

  #     - name: Save k6 summary artifacts
  #       if: always()
  #       run: |
  #         if [ -f report.html ]; then echo "report found"; else echo "no report.html yet"; fi
  #         ls -la || true

  #     - uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: k6-http-report
  #         path: |
  #           report.html
  #           summary.txt
  #         if-no-files-found: ignore

  k6-browser:
    if: ${{ github.event.inputs.run_browser == 'true' || github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: üöÄ Run k6 Browser Test
        continue-on-error: true
        id: k6-test
        run: |
          docker run --rm \
            -e K6_BROWSER_HEADLESS=true \
            -e K6_BROWSER_ARGS='--no-sandbox --disable-dev-shm-usage' \
            -e BASE_URL="${{ github.event.inputs.base_url || 'https://www.holisteek.com' }}" \
            -e CITY_QUERY="${{ github.event.inputs.city_query || 'London' }}" \
            -v "$PWD:/work" -w /work \
            --cap-add=SYS_ADMIN \
            --security-opt seccomp=unconfined \
            grafana/k6:master-with-browser \
            run --summary-trend-stats='avg,p(90),p(95),max' \
            scripts/browser/holisteek_flow.browser.js
      
      - name: ‚ö†Ô∏è Verificar si fallaron thresholds
        if: steps.k6-test.outcome == 'failure'
        run: |
          echo "::warning::‚ö†Ô∏è Los thresholds de k6 fueron superados, pero el test continu√≥ ejecut√°ndose."
          echo "::warning::Revisa el reporte HTML en GitHub Pages para ver los resultados detallados."

      - name: ÔøΩ Desplegar reporte a GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          destination_dir: reports/${{ github.run_number }}
          include_assets: report.html

      - name: üìã Subir Summary JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-browser-summary
          path: summary.json
          retention-days: 30

      - name: üìà Comentar resultados en PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = '## üìä Resultados K6 Browser Test\n\n';
            
            try {
              const data = JSON.parse(fs.readFileSync('summary.json', 'utf8'));
              const m = data.metrics;
              
              // Checks
              const checksRate = (m.checks?.values?.rate * 100 || 0).toFixed(2);
              const checksTotal = (m.checks?.values?.passes || 0) + (m.checks?.values?.fails || 0);
              
              // Errores
              const errorRate = (m.tasa_errores?.values?.rate * 100 || 0).toFixed(2);
              
              summary += `### ‚úÖ Validaciones\n`;
              summary += `- **Checks:** ${m.checks?.values?.passes || 0}/${checksTotal} (${checksRate}%)\n`;
              summary += `- **Tasa de Errores:** ${errorRate}%\n\n`;
              
              summary += `### ‚è±Ô∏è Tiempos de Respuesta\n`;
              summary += `- **Carga P√°gina Home:** ${(m.carga_pagina_home_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Selecci√≥n Ciudad:** ${(m.tiempo_seleccion_ciudad_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Carga Resultados:** ${(m.tiempo_carga_resultados_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Flujo Completo:** ${(m.tiempo_total_flujo_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n\n`;
              
              summary += `### üåê Core Web Vitals\n`;
              summary += `- **LCP:** ${(m.browser_web_vital_lcp?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **FCP:** ${(m.browser_web_vital_fcp?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **CLS:** ${(m.browser_web_vital_cls?.values?.avg || 0).toFixed(6)}\n`;
              summary += `- **FID:** ${(m.browser_web_vital_fid?.values?.avg || 0).toFixed(2)}ms\n\n`;
              
              const reportUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/reports/${context.runNumber}/report.html`;
              summary += `üìä **[Ver Reporte Completo HTML ‚Üí](${reportUrl})**\n`;
              
            } catch (error) {
              summary += `‚ö†Ô∏è Error al leer summary.json: ${error.message}\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
