name: k6 load + browser

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'BASE_URL de Holisteek'
        required: true
        default: 'https://www.holisteek.com'
      city_query:
        description: 'Ciudad a buscar'
        required: true
        default: 'London'
      run_browser:
        description: 'Ejecutar suite de navegador (true/false)'
        required: true
        default: 'true'
  # Programa autom√°tico para ejecutar tests peri√≥dicamente
  schedule:
    - cron: "0 9 * * *"  # Diario a las 9 AM UTC
  # Ejecutar en cada push/PR
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # k6-http:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Run k6 (HTTP)
  #       uses: docker://grafana/k6:latest
  #       with:
  #         args: >-
  #           run --summary-trend-stats=avg,p(90),p(95),max
  #           scripts/http/home_search_city.http.js
  #       env:
  #         BASE_URL: ${{ github.event.inputs.base_url }}
  #         CITY_QUERY: ${{ github.event.inputs.city_query }}
  #         VU: '20'
  #         DURATION: '1m'

  #     - name: Save k6 summary artifacts
  #       if: always()
  #       run: |
  #         if [ -f report.html ]; then echo "report found"; else echo "no report.html yet"; fi
  #         ls -la || true

  #     - uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: k6-http-report
  #         path: |
  #           report.html
  #           summary.txt
  #         if-no-files-found: ignore

  k6-browser:
    if: ${{ github.event.inputs.run_browser == 'true' || github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üìÅ Crear directorios y dar permisos
        run: |
          mkdir -p screenshots
          chmod 777 screenshots
          touch report.html summary.json
          chmod 666 report.html summary.json

      - name: üöÄ Run k6 Browser Test con InfluxDB v2
        run: |
          docker run --rm \
            -e K6_BROWSER_HEADLESS=true \
            -e K6_BROWSER_ARGS='--no-sandbox --disable-dev-shm-usage' \
            -e BASE_URL="${{ github.event.inputs.base_url || 'https://www.holisteek.com' }}" \
            -e CITY_QUERY="${{ github.event.inputs.city_query || 'London' }}" \
            -e K6_INFLUXDB_ORGANIZATION="${{ secrets.INFLUXDB_ORG }}" \
            -e K6_INFLUXDB_BUCKET="${{ secrets.INFLUXDB_BUCKET }}" \
            -e K6_INFLUXDB_TOKEN="${{ secrets.INFLUXDB_TOKEN }}" \
            -e K6_INFLUXDB_INSECURE="${{ secrets.INFLUXDB_INSECURE || 'false' }}" \
            -v "$PWD:/work" -w /work \
            -u $(id -u):$(id -g) \
            --cap-add=SYS_ADMIN \
            --security-opt seccomp=unconfined \
            mostafamoradian/xk6-browser-influxdb:latest \
            run --summary-trend-stats='avg,p(90),p(95),max' \
            --out xk6-influxdb=${{ secrets.INFLUXDB_URL }} \
            scripts/browser/holisteek_flow.browser.js

      - name: üìä Subir Reporte HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-browser-report-html
          path: report.html
          retention-days: 30

      - name: üì∏ Subir Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-browser-screenshots
          path: screenshots/
          retention-days: 30

      - name: üìã Subir Summary JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-browser-summary
          path: summary.json
          retention-days: 30

      - name: üìà Comentar resultados en PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = '## üìä Resultados K6 Browser Test\n\n';
            
            try {
              const data = JSON.parse(fs.readFileSync('summary.json', 'utf8'));
              const m = data.metrics;
              
              // Checks
              const checksRate = (m.checks?.values?.rate * 100 || 0).toFixed(2);
              const checksTotal = (m.checks?.values?.passes || 0) + (m.checks?.values?.fails || 0);
              
              // Errores
              const errorRate = (m.tasa_errores?.values?.rate * 100 || 0).toFixed(2);
              
              summary += `### ‚úÖ Validaciones\n`;
              summary += `- **Checks:** ${m.checks?.values?.passes || 0}/${checksTotal} (${checksRate}%)\n`;
              summary += `- **Tasa de Errores:** ${errorRate}%\n\n`;
              
              summary += `### ‚è±Ô∏è Tiempos de Respuesta\n`;
              summary += `- **Carga P√°gina Home:** ${(m.carga_pagina_home_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Selecci√≥n Ciudad:** ${(m.tiempo_seleccion_ciudad_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Carga Resultados:** ${(m.tiempo_carga_resultados_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **Flujo Completo:** ${(m.tiempo_total_flujo_ms?.values?.avg / 1000 || 0).toFixed(2)}s\n\n`;
              
              summary += `### üåê Core Web Vitals\n`;
              summary += `- **LCP:** ${(m.browser_web_vital_lcp?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **FCP:** ${(m.browser_web_vital_fcp?.values?.avg / 1000 || 0).toFixed(2)}s\n`;
              summary += `- **CLS:** ${(m.browser_web_vital_cls?.values?.avg || 0).toFixed(6)}\n`;
              summary += `- **FID:** ${(m.browser_web_vital_fid?.values?.avg || 0).toFixed(2)}ms\n\n`;
              
              summary += `üìé [Ver reporte HTML](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n`;
              summary += `üìä [Ver en Grafana](${process.env.GRAFANA_URL || 'http://localhost:3000'})\n`;
              
            } catch (error) {
              summary += `‚ö†Ô∏è Error al leer summary.json: ${error.message}\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
